# from django

from django.utils.deprecation import MiddlewareMixin


def set_operation_id_scope():
    from sentry_sdk import configure_scope
    with configure_scope() as scope:
        from django_swagger_utils import local

        operation_id = getattr(local, 'operation_id', '')
        scope.set_tag("operation_id", operation_id)

        app_name = getattr(local, 'app_name', '')
        scope.set_tag("app_name", app_name)

        user_id = getattr(local, 'user_id', 'GUEST')
        scope.set_tag("user_id", user_id)


class DSUDataMiddleware(MiddlewareMixin):

    def process_response(self, request, response):
        set_operation_id_scope()
        return response

    def process_exception(self, request, exception):
        set_operation_id_scope()

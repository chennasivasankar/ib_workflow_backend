import requests
from django.conf import settings

from ib_users.interactors.third_party.call_service import CallService


class CallServiceImpl(CallService):
    def __init__(self, message_template: str):
        self.message_template = message_template

    def request_call(self, country_code, phone_number, otp):
        msg = self.message_template.format(otp=otp)

        payload = {
            'authkey': settings.MSG91_AUTH_KEY,
            'mobile': "{}{}".format(country_code, phone_number),
            'message': msg,
            'sender': settings.DEFAULT_SMS_SENDER_ID,
            'otp': otp
        }

        url = self._action_url_builder('sendotp.php')
        requests.post(url, data=payload, verify=False)

    @staticmethod
    def _action_url_builder(action_url):
        return "http://control.msg91.com" + '/api/' + str(action_url)

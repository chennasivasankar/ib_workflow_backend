import uuid

from mock import create_autospec

from ib_users.interactors.login.login_user_to_device import LoginUserToDevice
from ib_users.interactors.logout.logout_in_devices import \
    LogoutInDevices
from ib_users.interactors.storages.user_login_device_details_storage import \
    UserLoginDeviceDetailsStorage, UserDeviceLoginDTO


class TestsLoginUserToDevice:
    def test_create_given_login_device_mapping_with_restriction_to_single_device(self):
        storage_mock = create_autospec(UserLoginDeviceDetailsStorage)
        login_user_to_device = LoginUserToDevice(storage_mock)
        user_id = "user_id"
        user_device_login_dto = UserDeviceLoginDTO(
            user_id="user_id",
            device_id="device_id",
            access_token="access_token"
        )
        logout_in_devices = create_autospec(LogoutInDevices)

        login_user_to_device.create_given_login_device_mapping(
            user_device_login_dto=user_device_login_dto,
            restrict_access_to_specific_device=True,
            logout_in_devices_interactor=logout_in_devices)

        storage_mock.create_given_login_device_mapping_in_storage.assert_called_once()
        logout_in_devices.logout_in_devices_except_of_given_access_tokens.\
            assert_called_once_with(
                user_id=user_id,
                access_tokens=[user_device_login_dto.access_token]
            )

    def test_create_given_login_device_mapping_without_restriction_to_single_device(self):
        storage_mock = create_autospec(UserLoginDeviceDetailsStorage)
        login_user_to_device = LoginUserToDevice(storage_mock)
        user_device_login_dto = UserDeviceLoginDTO(
            user_id="user_id",
            device_id="device_id",
            access_token="access_token"
        )
        logout_in_devices = create_autospec(LogoutInDevices)
        login_user_to_device.create_given_login_device_mapping(
            user_device_login_dto=user_device_login_dto,
            restrict_access_to_specific_device=False,
            logout_in_devices_interactor=logout_in_devices)
        storage_mock.create_given_login_device_mapping_in_storage.assert_called_once()
        logout_in_devices.logout_in_all_devices.assert_not_called()

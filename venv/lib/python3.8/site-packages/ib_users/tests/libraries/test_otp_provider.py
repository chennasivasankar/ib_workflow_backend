from datetime import datetime, timedelta
from freezegun import freeze_time


def test_generate_same_user_code_in_configured_time():
    from ib_users.third_party.pyotp_provider import PyOTPProvider

    pyotp_provider = PyOTPProvider()

    user_secret = "secrethash"
    configured_time_in_seconds = 10

    freezer = freeze_time("2019-05-23")
    freezer.start()

    otp = pyotp_provider.generate_time_based_code_for_user(
        user_secret, configured_time_in_seconds)
    assert otp == "356981"
    new_time = datetime.now()+timedelta(seconds=8)
    freezer.stop()
    freezer = freeze_time(new_time)
    freezer.start()

    new_otp = pyotp_provider.generate_time_based_code_for_user(
        user_secret, configured_time_in_seconds)

    assert new_otp == otp
    freezer.stop()


def test_generate_different_user_code_after_configured_time():
    from ib_users.third_party.pyotp_provider import PyOTPProvider

    pyotp_provider = PyOTPProvider()

    user_secret = "secrethash"
    configured_time_in_seconds = 10

    freezer = freeze_time("2019-05-23")
    freezer.start()

    otp = pyotp_provider.generate_time_based_code_for_user(
        user_secret, configured_time_in_seconds)
    assert otp == "356981"
    new_time = datetime.now()+timedelta(seconds=11)
    freezer.stop()

    freezer = freeze_time(new_time)
    freezer.start()

    new_otp = pyotp_provider.generate_time_based_code_for_user(
        user_secret, configured_time_in_seconds)

    assert new_otp != otp
    freezer.stop()

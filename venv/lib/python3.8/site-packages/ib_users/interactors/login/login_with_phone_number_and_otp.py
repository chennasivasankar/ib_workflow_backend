from dataclasses import dataclass

from ib_users.interactors.login.base_login import BaseLogin
from ib_users.interactors.storages.user_accounts_storage import PhoneNumberDTO, \
    UserAccountsStorage
from ib_users.interactors.third_party.otp_service import OTPService
from ib_users.interactors.validators.phone_number_validator import \
    PhoneNumberValidator


@dataclass
class PhoneNumberAndOTPDTO:
    phone_number_dto: PhoneNumberDTO
    otp: str


class LoginWithPhoneNumberAndOTP(BaseLogin):

    def __init__(self,
                 storage: UserAccountsStorage,
                 phone_number_validator: PhoneNumberValidator,
                 otp_service: OTPService):
        super().__init__(storage)
        self.otp_service = otp_service
        self.phone_number_validator = phone_number_validator

    def get_user_id_for_given_login_data(self,
                                         phone_number_login_dto: PhoneNumberAndOTPDTO):
        self.phone_number_validator.validate(
            phone_number_login_dto.phone_number_dto)

        user_id = self.storage.get_user_id_given_phone_number(
            phone_number_login_dto.phone_number_dto)
        super().validate_user_account_for_active_state(user_id)
        self.otp_service.validate_otp_send_to_phone_number(
            phone_number_dto=phone_number_login_dto.phone_number_dto,
            otp=phone_number_login_dto.otp)
        return user_id
